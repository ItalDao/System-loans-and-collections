<!DOCTYPE html>
<html lang="es">
<%- include('../partials/head') %>
<body>
    <div class="container-fluid">
        <div class="row flex-nowrap">
            <%- include('../partials/sidebar') %>

            <div class="col py-4">
                <div class="container-lg">
                    <div class="d-flex justify-content-between align-items-center mb-5 pb-3 border-bottom border-light">
                        <div>
                            <h1 class="mb-1"><i class="bi bi-graph-down" style="color: #ef4444;"></i> Gastos Operativos</h1>
                            <p class="text-muted mb-0">Registra y analiza los gastos de tu negocio</p>
                        </div>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalGasto">
                            <i class="bi bi-plus-circle-fill"></i> Nuevo Gasto
                        </button>
                    </div>

                    <% if(mensajeExito && mensajeExito.length > 0) { %>
                        <div class="d-none" id="flashMessageSuccess"><%= mensajeExito %></div>
                    <% } %>
                    <% if(mensajeError && mensajeError.length > 0) { %>
                        <div class="d-none" id="flashMessageError"><%= mensajeError %></div>
                    <% } %>

                    <div class="card card-box p-4 mb-4 border-0">
                                <input type="text" name="q" class="form-control" placeholder="Descripción o Categoría..." value="<%= busqueda %>">
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-dark">Filtrar</button>
                                <% if(busqueda) { %>
                                    <a href="/gastos" class="btn btn-outline-secondary">Limpiar</a>
                                <% } %>
                            </div>
                        </form>
                    </div>

                    <div class="card card-box p-3">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>FECHA</th>
                                        <th>DESCRIPCIÓN</th>
                                        <th>CATEGORÍA</th>
                                        <th>REGISTRADO POR</th>
                                        <th class="text-end">MONTO</th>
                                        <th class="text-center">ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (gastos.length > 0) { %>
                                        <% gastos.forEach(g => { %>
                                            <tr>
                                                <td><%= new Date(g.fecha_gasto).toLocaleDateString() %></td>
                                                <td class="fw-bold"><%= g.descripcion %></td>
                                                <td><span class="badge bg-secondary"><%= g.categoria %></span></td>
                                                <td class="text-muted small"><%= g.registrado_por %></td>
                                                
                                                <td class="text-end text-danger fw-bold">
                                                    - <%= empresa.moneda %> <%= parseFloat(g.monto).toFixed(2) %>
                                                </td>
                                                
                                                <td class="text-center">
                                                    <a href="/gastos/eliminar/<%= g.id %>" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar este gasto?');">
                                                        <i class="bi bi-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr><td colspan="6" class="text-center py-5 text-muted">No hay gastos registrados.</td></tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <% if (totalPages > 1) { %>
                            <nav class="mt-4 d-flex justify-content-between align-items-center">
                                <small class="text-muted">Página <%= currentPage %> de <%= totalPages %></small>
                                <ul class="pagination mb-0">
                                    <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>">
                                        <a class="page-link" href="/gastos?page=<%= currentPage - 1 %>&q=<%= busqueda %>">Anterior</a>
                                    </li>
                                    <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                                        <a class="page-link" href="/gastos?page=<%= currentPage + 1 %>&q=<%= busqueda %>">Siguiente</a>
                                    </li>
                                </ul>
                            </nav>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGasto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Registrar Nuevo Gasto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/gastos/guardar" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <input type="text" name="descripcion" class="form-control" required placeholder="Ej: Pago de luz, Artículos de oficina...">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Monto (<%= empresa.moneda %>)</label> <input type="number" step="0.01" name="monto" class="form-control" required placeholder="0.00">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Categoría</label>
                                <select name="categoria" class="form-select">
                                    <option value="Servicios">Servicios</option>
                                    <option value="Alquiler">Alquiler</option>
                                    <option value="Sueldos">Sueldos</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observación (Opcional)</label>
                            <textarea name="observacion" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Registrar Salida</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<%- include('../partials/footer') %>